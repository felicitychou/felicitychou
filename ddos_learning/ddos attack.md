# ddos attack 

1. 基本概念
2. python攻击脚本实现


早期的拒绝服务攻击主要基于系统和应用程序的漏洞，只需要几个请求或数据包就能导致长时间的服务不可用，但只要系统和应用程序修补的漏洞，就不受影响。同时，这种攻击也非常容易被入侵检测系统发现。

分布式拒绝服务攻击：利用分布式的客户端，向服务提供者发起大量看似合法的请求，消耗或长期占用大量资源，从而达到拒绝服务的目的。分为三类 攻击网络带宽资源、攻击系统资源和攻击应用资源。无法通过系统升级或打补丁的方式阻止，也不能用入侵检测系统进行防御。



攻击网络带宽资源

- 直接攻击：使用大量受控主机直接向被攻击目标发送大量的网络数据包，以占满被攻击目标的带宽，并消耗服务器和网络设备的网络数据处理能力，达到拒绝服务的目的。

  - ICMP／IGMP洪水攻击

    向目标发送大量ICMP/IGMP报文。工具：hping   现状：已不多见，被攻击目标可在网络边界直接过滤并丢弃ICMP／IGMP数据包，防御该攻击。

  - UDP洪水攻击

    小包：64字节大小的数据包。传输数据帧最小值。相同流量，单包体积越小，数据包数量越多。由于网络设备需要对每一个数据包进行检查和校验。数据包数量越多，网络设备处理数据包的压力越大，造成处理速度的缓慢和传输延迟等拒绝服务攻击的效果。

    大包：1500字节以上的数据包，超过以太网的最大传输单元（MTU），该攻击能有效占用网络接口的传输带宽，迫使被攻击目标接收到数据包时进行分片重组，造成网络拥堵、服务器响应速度变慢。工具：hping、LOIC 现状：但洪水攻击完全依靠受控主机本身的网络性能，因此对攻击目标带宽资源的消耗并不大。

  - 隐藏技术：伪造源IP地址

- 反射和放大攻击 

  - DRDoS 分布式反射拒绝服务

    目的IP地址指向作为反射器的服务器、路由器等设备，而源IP地址则被伪造成被攻击目标的IP地址。
    反射器在收到数据包时，会认为该数据包是被攻击目标发来的请求，因此会将响应数据发送给被攻击目标。当大量响应数据包涌向攻击目标是，就会耗尽目标的网络带宽资源，造成拒绝服务攻击。

    大量反射器。

    通常使用无需认证或握手的协议。因此，绝大多数的反射攻击都是使用基于UDP协议的网络服务进行的。

  - 放大攻击（利用反射原理的放大攻击）
    反射器对于网络流量具有放大作用，因此反射器也称为放大器。
    反射器提供的网络服务协议中，需要存在请求和响应数据量不对称的情况。响应数据量需要大于请求数据量，响应数据量与请求数据量的比值越大，放大器的放大倍数也就越大，进行放大攻击所产生的消耗带宽资源的效果也就越明显。

    放大器所使用网络服务部署的广泛性决定了该放大攻击的规模和严重程度。

  - ACK反射攻击
     通过受控主机向大量不同的服务器发送伪造源IP的SYN请求，然后服务器响应的大量ACK应答数据涌向被攻击目标，占用目标的网络带宽资源并造成拒绝服务。
     需要先进行扫描，获得大量的反射器地址。
     优点，能够比较有效地隐藏攻击的来源。

  - DNS放大攻击
    TCP/UDP端口53，主要使用UDP，响应数据包比查询数据包大，利用普通的DNS查询请求就能够发动放大攻击，并将攻击流量放大2~10倍。但更有效的方法是使用RFC 2671 中定义的DNS扩展机制 EDNS0。EDNS0扩展了DNS数据包的结构，增加了OPT RR字段。该字段包含了客户端能够处理的组大UDP报文大小的信息。服务端在响应DNS请求是，解析并记录下客户段能够处理的最大UDP报文的大小，并根据大小生成响应报文。

    攻击这能够利用dig Domain Information 和 EDNS0 进行高效的DNS放大攻击。攻击者向广泛存在的开放DNS解析器发送dig查询命令，将OPT RR字段中的UDP报文大小设置为很大的值，并将请求的源IP地址伪造成被攻击目标的IP地址。DNS解析器收到查询请求后，会将解析的结果发送给被攻击目标。大量解析结果涌向目标时，造成拒绝服务攻击。查询请求数据包大小一般为60字节，查询返回结果的数据包大小通常为3000字节以上。
    需要先进行扫描，获得大量的开放DNS解析器的地址。

  - NTP放大攻击  
    UDP 123端口 
    Mode 7 调试接口，而接口中的monlist请求能够获取到与目标NTP服务器进行同步的最后600个客户段的IP地址等信息。
    monlist请求返回的数据量与一段时间内和NTP服务器交互的客户端数量有关。攻击者可以将伪造源ip地址的UDP请求包发送NTP放大器，伪造客户端与NTP服务器的交互，增加monlist请求的响应数据量并增大NTP放大器的放大倍数。攻击者发送的monlist请求数据包大小不超过64字节，而请求返回的结果会包含100个482字节的UDP响应数据，使用该往事进行放大攻击能够达到700倍以上的放大结果。
    需要先进行网络扫描，以获得大量的NTP服务器。

  - SNMP放大攻击
    UDP 161端口 
    利用SNMP协议中的默认通信字符串和GetBulk请求。最常见的默认通信字符串是public 和private，除此之外还有许多厂商私有的默认通信字符串。
    SNMPv1中定义的Get请求可以尝试一次获取多个MIB对象，但响应消息的大小受到设备处理能力的限制。如果设备不能返回全部请求的响应，则会返回一条错误信息。在SNMPv2中，添加了GetBulk请求，该请求会通知设备返回尽可能多的数据，这使得管理程序能够通过发送一次请求就获得大段的检索信息。
    攻击者向广泛存在并开启了是你们漂浮物的网络设备发送GetBulk请求，使用默认通信字符串作为认证凭据，并将源IP地址伪造成攻击目标的IP地址。设备收到GetBulk请求会将响应结果发送给攻击目标。当大量的响应结果涌向攻击目标时，就会导致攻击目标网络拥堵和缓慢，造成拒绝服务攻击。
    攻击者发送的GetBulk请求数据包约为60字节，而请求的响应数据能达到1500字节以上，因此使用该方式进行放大攻击能够达到25倍以上的放大效果。
    需要先进行网络扫描找到SNMP协议的网络设备，猜测其使用的默认字符串。


- 攻击链路:攻击目标是骨干网的带宽资源

 - Coremelt攻击
   攻击这需要控制一个分布足够广泛的僵尸网络来发动Coremelt攻击。攻击者通过traceroute等手段来判断各个僵尸主机和将要攻击链路之间的位置关系，并根据结果将僵尸主机分为两个部分。然后，攻击者控制僵尸主机，是其与链路另一侧的每一台僵尸主机进行通信并收发大量数据。这样大量的网络数据包就会经过骨干网上的被攻击链路，造成网络拥堵和延时。
   没有办法将这些通信数据与真正合法通信数据进行有效的区分，因此，这种攻击方式更加难以防护和缓解。


攻击系统资源
   终端设备与服务器进行通信时，经常需要创建会话连接，在这个过程中通常会使用TCP和SSL等协议。在会话创建的初始阶段，服务器需要为新建立的连接分配资源；在会话过程中，服务器需要维护并更新连接的状态，并进行数据传输和交互；在会话结束之后，这些连接资源才会被释放。一旦被占满，新进入的会话请求就必须等待前面的会话完成。消耗系统资源的分布式服务攻击主要目的就是对系统维护的连接资源进行消耗和占用，阻止正常连接的建立。从未达到拒绝服务的目的。  

 - 攻击TCP连接
   TCP连接洪水攻击
   攻击者可以利用大量受控主机，通过快速建立大量的恶意的TCP连接占满被攻击目标的连接表，使目标无法接受新的TCP连接请求，从而达到拒绝服务攻击的目标。

   SYN 洪水攻击
   攻击者利用受控主机发送大量的TCP SYN报文，使服务器打开大量的半开连接，占满服务器的连接表，从而影响正常用户与服务器建立会话，造成拒绝服务。攻击者在发送TCP SYN报文时可以在收到服务器端返回的SYN+ACK报文后，跳过最后的ACK报文发送，使连接处于搬开状态，但是这样会很明显地暴露出进行SYN洪水攻击的攻击者IP地址，同时响应报文会作为反射流量占用攻击者的带宽资源。更好的方式是将SYN报文的源IP地址随机伪造成其他主机的IP地址或不存在的IP地址，这样攻击目标会将应答发送给被伪造的IP地址，从而占用连接资源并隐藏攻击来源。

   PSH+ACK洪水攻击
   带有PSH标志位的TCP数据包会强制要求接收端将接收缓冲区清空并将数据提交给应用服务进行处理。当攻击这利用受控主机向攻击目标发送大量的PSH+ACK数据包时，被攻击目标就会消耗大量的系统资源不断地进行接收缓冲区的清空处理，导致无法正常处理数据，从而造成拒绝服务攻击。
   单独使用PSH+ACK洪水攻击对服务器产生的影响并不十分明显，更有效的方式是SYN洪水攻击与ACK洪水攻击相结合，这样能够绕或一部分防护设备，增强攻击的效果。

   RST 洪水攻击
   攻击者利用大量的受控主机猜测端口和序列号，进行盲打，发动攻击。只要数量巨大的RST报文中有一条与攻击目标的端口号相同，并且序列号落在目标的接收窗口之中，就能够终端连接。 针对用户的拒绝服务攻击方式。

   Sockstress攻击：慢速攻击
   TCP传输数据时，并不是将数据直接递交给应用程序处理，而是先临时存储在接收缓冲区中，该接收缓冲区的大小是由TCP窗口表示的。如果TCP窗口大小为0.则表示接收缓冲区已被填满，发送盾啊应该停止发送数据，直到接收端的窗口发生了更新，Sockstress攻击就是利用该原理长时间维持TCP连接，以达到拒绝服务攻击的目标。
   Sockstress攻击建立TCP连接，但在三次握手的最后一次ACK应答中，攻击者将其TCP窗口大小设置为0，随后进行一次数据请求。被攻击目标在传输数据时，发现接收端的TCP窗口大小为0，就会停止传输数据，并发出TCP窗口探测包，询问攻击者其TCP窗口是否有更新。由于攻击者没有更改TCP窗口的大小，被攻击目标就会一致维持TCP连接等待数据发送，并不断进行窗口更新的探测。如果攻击者利用用大量的受控主机进行Sockstress攻击，被攻击目标会一直维持大量的TCP连接并进行大量窗口更新探测，其TCP连接表会逐渐耗尽，无法接受新的连接而导致拒绝服务。
   Sockstress攻击的另一种方式就是将TCP窗口设置为一个非常小的值。，被攻击目标将不得不把需要发送的数据切分成大量4字节大小的分片，这会极大地消耗目标的内存和处理器资源，在成系统响应缓慢和拒绝服务。

 - 攻击SSL连接
   THC SSL DoS 攻击
   利用Renegotiation选项，造成被攻击目标资源耗尽。在进行SSL连接并握手之后，攻击这反复不断进行密钥重新协商过程，而密钥重协商过程需要服务器投入比客户端多15倍的CPU资源

   SSL洪水攻击攻击者能够在客户端大量地发出攻击请求，需要客户端所进行的计算尽可能少。比较好的方式是在数据传输之前、进行SSL握手的过程中发动攻击。攻击者并不需要完成SSL握手和密钥交换，而只需要在这个过程中让服务器去解密和验证，就能够大量地消耗服务器的计算资源。
   攻击者可以使用SSLSqueeze等工具来发动SSL洪水攻击。

攻击应用资源
 - 攻击DNS服务

 DNS QUERY 洪水攻击
 向DNS服务器发送大量查询请求以达到拒绝服务效果。在DNS解析过程中，客户端发起一起查询请求，DNS服务器可能需要进行额外的多次查询才能完成解析的过程，并给出应答，在这个过程中会消耗一定的计算和网络资源。如果攻击者利用大量受控主机不断发送不同域名的解析请求，那么DNS服务器的缓存会被不断刷新，而大量受控主机不断发送不同域名的解析请求，那么DNS服务器的缓存会被不断刷新，而大量解析请求不能命中缓存又导致DNS服务其必须消耗额外的资源进行迭代查询，这会极大地增加DNS服务器的资源消耗，导致DNS响应缓慢甚至完全拒绝服务。
要点在于每一个DNS解析请求所查询的域名应是不同的，这样可以比较有效地避开DNS服务器缓存中的解析记录，达到更好的资源消耗效果、

DNS NXDOMAIN洪水攻击 是DNS QUERY 洪水攻击的一个变种攻击方式，区别在于后者是请求解析一个存在的域名，后者是查询不存在的域名。NXDOMAIN Non-eXistent Domain
在进行DNS NXDOMAIN洪水攻击时，DNS服务器会进行多次域名查询，同时，其缓存会被大量NXDOMAIN记录所填满，导致响应正常用户的DNS解析请求的速度变慢。一部分DNS服务器在获取不到域名的解析结果时，还会再次进行递归查询，向其上一级的DNS服务器发送解析请求并等待应答，这进一步增加DNS服务器的资源消耗。

 - 攻击WEB服务
  HTTP洪水攻击
  攻击者利用大量受控主机不断向Web服务器恶意发送大量HTTP请求，要求Web服务器处理，就会完全占用服务器的资源，造成其他正常用户的Web访问请求处理缓慢甚至得不到处理，导致拒绝服务。
  攻击者会使用HTTP代理服务器隐藏自己，并能够提高攻击的效率。高效的洪水攻击应不断发出针对不同资源和页面的HTTP请求，并尽可能请求无法被缓存的资源，从而家中服务器的负担，增强攻击效果。
  如果HTTPS则进行HTTPS洪水攻击是更为有效的一种攻击方式，一方面进行HTTPS通信时，WEB服务器需要消耗更多的资源用来进行认证和加解密。
  另一方面，一部分防护设备无法对HTTPS通信流进行处理，也会导致攻击流量绕过防护设备，直接对Web服务器造成攻击。

  Slowloris攻击 针对Web服务器的慢速HTTP攻击
  HTTP协议规定HTTP头部以连续的“\r\n\r\n” 作为结束标志。许多Web服务器在处理HTTP请求的头部信息时，会等待头部传输结束后再进行处理。因此，如果Web服务器没有接收到“\r\n\r\n”,就会一直接收数据并保持与客户端的连接资源。攻击者能够长时间与Web服务器保持连接，并逐渐耗尽Web服务器的连接资源。攻击这在发送 HTTP GET 请求时，缓慢地发送无用的header字段，并且一直不发送“\r\n\r\n”结束标志，这样就能够长时间占用Web服务器的连接并保证该连接不被超时中断。然而，Web服务器能够处理的并发连接数是有限的，如果攻击者利用大量的受控主机发送这种不完整的HTTP GET请求并持续占用这些连接，就会耗尽Web服务器的连接资源，导致其他用户的HTTP请求无法被处理，造成拒绝服务。
  攻击者使用Slowloris、slowhttptest等工具可以简单发动Slowloris攻击。

  慢速POST请求攻击 针对Web服务器的慢速HTTP攻击
  利用缓慢发送HTTP BODY的方式达到占用并耗尽Web服务器连接资源的目的。
  在HTTP头部信息中可以使用Contenet-Length字段来指定HTTP消息实体的传输长度。当Web服务器接收到请求头部中含有Content-Length字段时，服务器会将该字段的值作为HTTP BODY的长度，持续接收数据并在达到Content-Length值时对HTTP BODY 的数据内容进行处理。利用这个特性，攻击者能够长时间与Web服务器保持连接，并逐渐耗尽Web服务器的连接资源。
  攻击者在发送HTTP POST 请求时，在请求头部中将Content-Length设置为一个很大的值，并将HTTP BODY 以非常缓慢的速度一个个字节的发送。Web就需要一致维持与客户端的连接并等待数据传输结束。
  如果攻击者利用大量的受控主机发送这种缓慢的HTTP POST请求并持续闸弄这些连接，就会耗尽Web服务器的连接资源，导致其他用户的HTTP请求无法被处理，造成拒绝服务。

  数据处理过程攻击
  恶意构造请求数据的内容，攻击者可以显著增加数据处理过程中的资源消耗，造成拒绝服务攻击。

  正则表达式拒绝服务攻击 ReDoS
  Web应用在处理请求数据是，通常会使用正则表达式进行字符串的匹配操作。
  如果Web应用中的正则表达式写的不够好，需要测试的匹配路径数量会随着输入字符串的长度呈指数级增长。利用恶意构造的输入字符串，攻击者提交相对较短的输入字符串，就可以强制正则引擎处理数亿个匹配路径，所需要的时间可以达到几个小时甚至几天。只需要几个这种类似的恶意正则表达式匹配请求，就能够完全占用Web服务器的计算资源，造成Web服务器拒绝服务。



  哈希冲突拒绝服务攻击
  Web应用在处理请求中的POST数据时，通常使用键-值对的来进行存储。在大多数语言中，键-值对的实质是一个哈希表，Web应用程序通过计算“键”的哈希来获取其对应的值，正常情况下，这个华西表中的哈希冲突较少，因此查询和插入的速度很快。如果攻击者构造一组恶意的POST数据，使得请求中的“键”的哈希值全部相同，那么保存POST数据的哈希表就会因此退化称为链表，对哈希表的查询和插入等操作则变成对链表的遍历操作，造成大量的计算资源被占用，导致拒绝服务攻击。


  拒绝服务攻击方法的分类

  |攻击分类|洪水攻击|慢速攻击|
  |--------|--------|--------|
  |网络层攻击|ICMP/IGMP洪水攻击||
  |传输层攻击|UDP洪水攻击|Sockstress攻击|
  ||TCP连接洪水攻击|THC SSL DoS攻击|
  ||SYN洪水攻击||
  ||PSH+ACK洪水攻击||
  ||ACK反射攻击||
  ||RST洪水攻击||
  ||SSL洪水攻击||
  |应用层攻击|DNS QUERY洪水攻击|Slowloris攻击|
  ||DNS NXDOMAIN 洪水攻击|慢速POST 请求攻击|
  ||DNS放大攻击|数据处理过程攻击|
  ||HTTP洪水攻击||
  ||SNMP放大攻击||
  ||NTP放大攻击||


DDoS攻击的工具
Hping www.hping.org ICMP/UDP/SYN
PenTBox www.pentbox.net SYN/TCP
Zarp github.com/hatRiot/zarp SYN
LOIC HOIC HULK github.comNewEraCracker/LOIC UDP/TCP/HTTP GET
Slowloris ckers.org/slowloris HTTP GET
R.U.D.Y. 慢速HTTPPOST HTTP POST
THC SSL DOS www.thc.org/thc-ssl-dos SSL renegotiation

























